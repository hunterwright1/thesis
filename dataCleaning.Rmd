---
title: "Thesis Data Prep"
author: "Hunter Wright"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
library(pacman)
p_load(dplyr, broom, ggplot2, tidyverse, readr, purrr, tidyr)

```

```{r clean data example}
jan15w1_dirty <- read_csv("data/2015/week1.csv")

jan15w1 <- jan15w1_dirty %>%
  slice(6, 22, 40, 60, 81, 89, 98, 116, 117) %>%
  select(-"...9", -"Usage By Hour And Day Grouped By Membership") %>%
  relocate("...2", .after = "...8") %>%
  rename(
    "2015-01-11" = "...2",
    "2015-01-05" = "...3",
    "2015-01-06" = "...4",
    "2015-01-07" = "...5",
    "2015-01-08" = "...6",
    "2015-01-09" = "...7",
    "2015-01-10" = "...8"
  )
rownames(jan15w1) <- c("Day", "No Membership Total", "Alumni Total", "Community Member Total", "Student Total", "Student 1 Total", "Faculty/Staff Total", "PE/Rec Staff Total", "Total" )

jan15w1 <- as.data.frame(t(jan15w1))

print(jan15w1)
```
```{r import 2015 dataset, include=FALSE}
library(gtools)

# Set the folder path (update this to your actual folder)
folder_path <- "data/2015"

# List CSV files in natural order
files2015 <- mixedsort(list.files(path = folder_path, pattern = "\\.csv$", full.names = TRUE))

# Read and combine all CSVs into one data frame
year2015 <- files2015 %>% 
  map_dfr(read_csv)
```
```{r remove junk rows}

df2015 <- as.data.frame(year2015) %>% #convert to data frame
  rename("column1" = "Usage By Hour And Day Grouped By Membership") %>%
  select(-"...9") %>% 
  filter(!(.[[1]] == "Parameters")) %>%
  filter(!(str_detect(column1, "PM") & str_detect(column1, "AM") & str_detect(column1, "-"))) %>% 
  filter(!(str_detect(column1, "PM") & str_detect(column1, "-"))) %>%
  filter(!(str_detect(column1, "AM") & str_detect(column1, "-"))) %>%
  filter(!str_detect(column1, "Readers")) %>%
  filter(!str_detect(column1, "Days of the week")) %>%
  filter(!str_detect(column1, "Memberships")) %>%
  filter(!str_detect(column1, "2025")) %>%
  relocate("...2", .after = "...8")

```


```{r function}

clean <- function(file_path,
                  expected_cols = c("Date", "No Membership Total",
                                            "Alumni Members Total",
                                            "Community Members Total",
                                            "Current Student Total",
                                            "Current Student 1 Total",
                                            "Faculty & Staff Total",
                                            "PE & Rec Staff Total",
                                            "Class MWF Total",
                                            "Class TU/TR Total",
                                            "Club Sports - Limited Total")) {
 
  #read in csv
  raw <- read_csv(file_path, col_names = FALSE, show_col_types = FALSE)

 raw <- raw %>%
    relocate("X2", .after = "X8")
  
  date_range <- raw[[1]][3] #date range is in row 3 column 1
  
  #example: "Mon, Jan 5, 2015 12:00 AM to Sun, Jan 11, 2015 11:59 PM"
  date_parts <- strsplit(date_range, " to ")[[1]] #split at "to"
  
  #remove day and time
  #gsub: ^start from beginning, [^,]+ match one or more chars that are not a comma, \\s* match a comma followed by whitespace
  start_date <- as.Date(trimws(gsub("^[^,]+,\\s*", "", #removes day
                  sub(" 12:00 AM", "", date_parts[1]))), #remove 12:00 AM from first part of vector
                  format = "%b %d, %Y") #convert to R date object
  
  #initialize week dates
  week_dates <- seq(start_date, by = "day", length.out = 7)
  
  #identifying membership totals rows and names
  
  #return vector of rows that start with "Membership Totals:"
  totals_idx <- which(grepl("^Membership Totals:", raw[[1]]))
  
  #get the corresponding membership type rows
  #the last "Membership Type:" row preceding each totals row)
  type_idx <- which(grepl("^Membership Type:", raw[[1]])) #mem type vector
  membership_names <- c() #create vector to store names
  for (ti in totals_idx) { #iterate over each row index ti where the totals for a membership are recorded
    preceding <- type_idx[type_idx < ti] #find all rows from type_idx that come before the current totals row ti
    if (length(preceding) > 0) { #check if there is at least one membership type row before the totals row
      last_type <- max(preceding) #pick the last membership type row 
      mem_name <- trimws(sub("Membership Type:", "", raw[[1]][last_type]))
      membership_names <- c(membership_names, paste(mem_name, "Total"))
    } else {
      membership_names <- c(membership_names, NA)
    }
  }

  days_row <- raw[5, ] #create vector of days of the week
  
  data_rows <- bind_rows(days_row, raw[totals_idx, ]) #combine with totals 
  
  data_rows <- data_rows %>% 
    select(-1) #remove unneeded columns
  
  data_rows <- data_rows %>% 
    select(1:7) #keep the 7 columns corresponding to the days
  
  #replace the day names row with dates
  data_rows[1, ] <- as.list(format(week_dates, "%Y-%m-%d"))
  
  #transpose
  df <- as.data.frame(t(data_rows), stringsAsFactors = FALSE)
  
  #name columns
  colnames(df) <- c("Date", membership_names)
  
  #add NAs for missing columns
  for (mem in expected_cols) {
    if (!(mem %in% colnames(df))) {
      df[[mem]] <- NA
    }
  }
  
  return(df)
}

```

```{r create 2015 df}

#create list of years
years <- list.files("data", full.names = TRUE)

#combine
membership <- map_dfr(years, function(folder) {
  files <- list.files(folder, pattern = "week\\d+\\.csv", full.names = TRUE)
  map_dfr(files, clean)
}) %>% 
  arrange(Date)

membership <- membership %>%
  mutate(Date = as.Date(Date, format = "%Y-%m-%d"), #date column as Date type
         across(-Date, as.numeric)) %>% #set all columns to numeric
  complete(Date = seq(min(Date), max(Date), by = "day")) %>% #add missing days
  mutate(across(-Date, ~ replace_na(., 0))) #replace NAs with 0s

#remove junk columns and create other column, total column
membership2 <- membership %>%
  rename(date = Date,
         nonmembers = "No Membership Total",
         alumni = "Alumni Members Total",
         community_members = "Community Members Total",
         students = "Current Student Total",
         col1 = "Current Student 1 Total",
         faculty_staff = "Faculty & Staff Total",
         pe_staff = "PE & Rec Staff Total",
         col2 = "Class MWF Total",                                      
         col3 = "Class TU/TR Total",                                    
         col4 = "Club Sports - Limited Total",                          
         col5 = "Club Sports- Limited Total",                           
         col6 = "Guest Pass Total",                                     
         col7 = "Community Membership Total",                           
         col8 = "Club Sports- Basketball - Limited Hours Total",        
         col9 = "Club Sport Fencing - Limited Hours Total",             
         col10 = "Club Sports - Wushu - Limited Hours Total",            
         col11 = "Club Sports- W Water Polo- Limited Hours Total",       
         col12 = "Athletics - Tennis Total",                             
         col13 = "Club Sports - Jiu Jitsu - Limited Hours Total",        
         col14 = "Club Sports - Swim - Limited Hours Total",             
         col15 = "Faculty/Staff Total",                                  
         col16 = "NCU Semester Membership Total",                        
         col17 = "Spouse/Dependent Total",                               
         col18 = "Student Off Term Total",                               
         col19 = "NCU Total",                                            
         col20 = "Class MW Total",                                       
         col21 = "Dependent/Spouse Total",                               
         col22 = "Club Sports- Wrestling - Limited Hours Total",         
         col23 = "PE Volunteer MTWThF Total",                            
         col24 = "Class MTWTh Total",                                    
         col25 = "Club Sports - Dance - Limited Hours Total",            
         col26 = "PE Volunteer MW Total",                                
         col27 = "PE MW Total",                                          
         col28 = "SRC Access for IM Participants Total",                 
         col29 = "Spring 2021 - Faculty/Staff GX Turnstile Access Total",
         col30 = "Worlds 2022 Staff Membership Total",                   
         col31 = "Winter 2021 - Faculty/Staff GX Turnstile Access Total",
         col32 = "PE T/R Total",                                         
         col33 = "Bushnell Total",                                       
         col34 = "Club Sports - Kendo - Limited Hours Total",            
         col35 = "Courtesy Total",                                       
         col36 = "Club Sports - Kendo Total",                            
         col37 = "Bushnell Semester Membership Total",                   
         col38 = "Club Sports - Weightlifting - Limited Hours Total",    
         col39 = "Club Sports Hockey Total",                             
         col40 = "PE Volunteer M/W Total"
         ) %>%
  mutate(other = col2 + col3 + col4 + col5  + col6  + col7  + col8  + col9  + col10 + col11 + col12 + col13 + col14 + col15 + col16 + col17 + col18 + col19 + col20 + col21 + col22 + col23 + col24 + col25 + col26 + col27 + col28 + col29 + col30 + col31 + col32 + col33 + col34 + col35 + col36 + col37 + col38 + col39 + col40,
         total = nonmembers + alumni + community_members + students + faculty_staff + pe_staff + other) %>%
  select(1:5, 7, 8, 48, 49)

```





